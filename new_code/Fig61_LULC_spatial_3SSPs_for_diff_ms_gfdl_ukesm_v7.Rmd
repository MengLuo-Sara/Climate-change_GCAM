---
title: "GTM_4_dim_var_process"
author: "Meng Luo"
date: "2023-08-29"
output: html_document
    toc: true
    toc_float: true
---
# use the mature age's FP as the input for GCAM


#########################################################
## update of the this version
# add FULL_matrix_for_MFP_continue

# Content
## link to github
  S0 link to github
## Setting Up
  S1 needed R package and dir
 
  
  
  
  
# link to github
```{r S0 link to github , include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)
```

# Setting Up
## Loading Needed R Packages and Setting Directory

```{r S1 needed R package and dir }
#install.packages("drake")
library('drake')
#install.packages("cowplot")
library(cowplot)
############
require(devtools)
#Please use this in console if needed: install_github('JGCRI/rgcam', build_vignettes=TRUE, force =TRUE)
library (rgcam)
library(tidyverse)
library(tidyr)

library(rlang)
library(dplyr)
# install.packages("patchwork")
library(patchwork)
# install.packages("sf")
library(sf)
# install.packages("svglite")
library(svglite)
library(cowplot)
library(gridExtra)
library(ggthemes)
library(stringr)
library(ggplot2)
library(RColorBrewer)


## run this in console devtools::load_all()

Fig_num_name<-"Fig61_LULCC"
version_num <-"6"
case_name<-"_climate_productivityC"
#################################################################################################
## need to modify 
# plot_case<-1 # diff SSPs


case<-"CC_components"


## end of need to modify 
# read from hard disk ##############################################################
# # Chen lab desktop
# # root<-"O:/"
# 
# # 2023 laptop
# root<-"D:/"
# 
# 
# main_Sagb_path <- paste0(root, "E/new laptop2/PHD/phd_dissertation/climate_FPC_GCAM/Data/ISIMIP3b_processed/GCAM_subregion_mean/annual_wmean_aboveCD/region_5ymean_alltypes_wrapper/")
# 
# 
# main_Sbgb_path <- paste0(root, "E/new laptop2/PHD/phd_dissertation/climate_FPC_GCAM/Data/ISIMIP3b_processed/GCAM_subregion_mean/annual_wmean_belowCD/region_5ymean_alltypes_wrapper/")
# 
# 
# 
# XML_version <- paste0(version_num ,case_name,"_ssp",case) 

####

# main_GTM_mid_xml_path  <-"E/new laptop2/PHD/phd_dissertation/climate_FPC_GCAM/Data/GCAM data system_forestversion/useful/"
# main_my_XML_path <- "E/new laptop2/PHD/phd_dissertation/climate_FPC_GCAM/Data/GCAM data system_forestversion/new_XML/"
# # produce outputs in GCAM 7.0 release package 
# main_v7_XML_path <- "E/Docker_GCAM_v7_forest/gcam-master/input/gcamdata/xml/"
# 
# fig_save_path <- paste0(root,"E/new laptop2/PHD/my_2024_1_manuscript/Figure&table/figure/check_npp_rh_scaler_4in1_file/")

# Harmolandtype_area_main_path<-paste0(root,"E/new laptop2/PHD/phd_dissertation/climate_FPC_GCAM/Data/ISIMIP3b_processed/GCAM_subregion_mean/")
# read from 2023 laptop  ##############################################################

# 2023 laptop
# root <- "C:/MengLuo/chapter 2_backup/"

# NAS
root <- "Z:/Meng/back_up_all/9_updates/"




## database_basexdb/
# output_dir <- paste0(root, "E/Data/", sep='') 
in_csv_path <- paste0(root,"my_2024_1_manuscript/Figure&table/figure/compare_GCAM_out/LULCC spatial vertical bar/", sep='') 

########################################################################################


# main_Sagb_path <- paste0(root, "climate_FPC_GCAM/Data/ISIMIP3b_processed/GCAM_subregion_mean/annual_wmean_aboveCD/region_5ymean_alltypes_wrapper/")
# 
# 
# main_Sbgb_path <- paste0(root, "climate_FPC_GCAM/Data/ISIMIP3b_processed/GCAM_subregion_mean/annual_wmean_belowCD/region_5ymean_alltypes_wrapper/")

XML_version <- paste0(version_num ,case_name,"_ssp",case) 


#####

# main_GTM_mid_xml_path  <-"climate_FPC_GCAM/Data/GCAM data system_forestversion/useful/"
# main_my_XML_path <- "climate_FPC_GCAM/Data/GCAM data system_forestversion/new_XML/"
# # produce outputs in GCAM 7.0 release package 
# main_v7_XML_path <- "XML_save/"

fig_save_path <- paste0(root,"my_2024_1_manuscript/Figure&table/figure/compare_GCAM_out/LULCC spatial/")

# Harmolandtype_area_main_path<-paste0(root,"climate_FPC_GCAM/Data/ISIMIP3b_processed/GCAM_subregion_mean/")



shp_path <- paste0(root, "climate_FPC_GCAM/Code/boundary/gcam_boundaries_moirai_3p1_0p5arcmin_wgs84/gcam_boundaries_moirai_3p1_0p5arcmin_wgs84/main_outputs/region_boundaries_moirai_combined_3p1_0p5arcmin.shp")

data_sf <- st_read(shp_path)
```


## read GTM output txt file
separate each var and save in csv

# function section


```{r S2 function save_result }
save_csv_result <- function(result_DF, result_csv_name,row_names) {

full_save_path <- paste0(root,main_GTM_path, result_csv_name)
if (row_names == TRUE) {
write.csv(result_DF,full_save_path, row.names = TRUE)
} else {
write.csv(result_DF,full_save_path, row.names = FALSE)
}

}
```

# preprocessing for GCAM XML
## I am right here


```{r S3 automatically read the file}

# agb_files <- list.files(path = main_Sagb_path, pattern = ".*_fullscalerc3c4.*\\.csv$", full.names = TRUE)
# 
# 
# bgb_files <- list.files(path = main_Sbgb_path, pattern = ".*_fullscalerc3c4.*\\.csv$", full.names = TRUE)
# 
# print(agb_files)
# print(bgb_files)
```

```{r S4 read the file}
in_fig_case_name<-"_v5_R12"

land.alloc.data.table_combine_diff_s_SSP126<-read.csv(paste0(in_csv_path, "Fig25_combine_diff_s_SSP126", in_fig_case_name,".csv"))
land.alloc.data.table_combine_diff_s_SSP370<-read.csv(paste0(in_csv_path, "Fig25_combine_diff_s_SSP370", in_fig_case_name,".csv"))
land.alloc.data.table_combine_diff_s_SSP585<-read.csv(paste0(in_csv_path, "Fig25_combine_diff_s_SSP585", in_fig_case_name,".csv"))


processed_combine_diff_s_SSP126<-land.alloc.data.table_combine_diff_s_SSP126%>%
  filter(year == 2100 )%>%
  mutate(landleaf = gsub("forest \\(managed\\)", "Managed forest", landleaf)) %>%
  mutate(landleaf = gsub("forest \\(unmanaged\\)", "Unmanaged forest", landleaf))%>%
  mutate(landleaf = gsub("pasture \\(other\\)", "Unmanaged pasture", landleaf))%>%
  mutate(landleaf = gsub("pasture \\(grazed\\)", "Managed pasture", landleaf))%>%
  mutate(landleaf = gsub("grass", "Grass", landleaf))%>%
  mutate(landleaf = gsub("shrub", "Shrub", landleaf))%>%
  # mutate(landleaf = gsub("rock and desert", "Rock and desert", landleaf))%>%
  # mutate(landleaf = gsub("urban", "Urban", landleaf))%>%
  # mutate(landleaf = gsub("tundra", "Tundra", landleaf))%>%
  mutate(landleaf = gsub("biomass", "Bioenergy", landleaf))%>%
  mutate(gfdl_ukesm_mean_for_diff = (default_updateall_gfdl_for_diff+default_updateall_ukesm_for_diff)/2)%>%
  dplyr::select(region,landleaf,year,gfdl_ukesm_mean_for_diff)%>%
  left_join(data_sf, by = c("region" = "reg_nm" ))


processed_combine_diff_s_SSP370<-land.alloc.data.table_combine_diff_s_SSP370%>%
  filter(year == 2100 )%>%
  mutate(landleaf = gsub("forest \\(managed\\)", "Managed forest", landleaf)) %>%
  mutate(landleaf = gsub("forest \\(unmanaged\\)", "Unmanaged forest", landleaf))%>%
  mutate(landleaf = gsub("pasture \\(other\\)", "Unmanaged pasture", landleaf))%>%
  mutate(landleaf = gsub("pasture \\(grazed\\)", "Managed pasture", landleaf))%>%
  mutate(landleaf = gsub("grass", "Grass", landleaf))%>%
  mutate(landleaf = gsub("shrub", "Shrub", landleaf))%>%
  # mutate(landleaf = gsub("rock and desert", "Rock and desert", landleaf))%>%
  # mutate(landleaf = gsub("urban", "Urban", landleaf))%>%
  # mutate(landleaf = gsub("tundra", "Tundra", landleaf))%>%
  mutate(landleaf = gsub("biomass", "Bioenergy", landleaf))%>%
  mutate(gfdl_ukesm_mean_for_diff = (default_updateall_gfdl_for_diff+default_updateall_ukesm_for_diff)/2)%>%
  dplyr::select(region,landleaf,year,gfdl_ukesm_mean_for_diff)%>%
  left_join(data_sf, by = c("region" = "reg_nm" ))


processed_combine_diff_s_SSP585<-land.alloc.data.table_combine_diff_s_SSP585%>%
  filter(year == 2100 )%>%
  mutate(landleaf = gsub("forest \\(managed\\)", "Managed forest", landleaf)) %>%
  mutate(landleaf = gsub("forest \\(unmanaged\\)", "Unmanaged forest", landleaf))%>%
  mutate(landleaf = gsub("pasture \\(other\\)", "Unmanaged pasture", landleaf))%>%
  mutate(landleaf = gsub("pasture \\(grazed\\)", "Managed pasture", landleaf))%>%
  mutate(landleaf = gsub("grass", "Grass", landleaf))%>%
  mutate(landleaf = gsub("shrub", "Shrub", landleaf))%>%
  # mutate(landleaf = gsub("rock and desert", "Rock and desert", landleaf))%>%
  # mutate(landleaf = gsub("urban", "Urban", landleaf))%>%
  # mutate(landleaf = gsub("tundra", "Tundra", landleaf))%>%
  mutate(landleaf = gsub("biomass", "Bioenergy", landleaf))%>%
  mutate(gfdl_ukesm_mean_for_diff = (default_updateall_gfdl_for_diff+default_updateall_ukesm_for_diff)/2)%>%
  dplyr::select(region,landleaf,year,gfdl_ukesm_mean_for_diff)%>%
  left_join(data_sf, by = c("region" = "reg_nm" ))
```







```{r break label function}
## keep 3 decimal
generateQuantileLabels <- function(quantile_breaks) {
  sapply(1:(length(quantile_breaks) - 1), function(i) {
    paste(format(round(quantile_breaks[i], 3), nsmall = 3),
          "-",
          format(round(quantile_breaks[i + 1], 3), nsmall = 3),
          sep = "")
  })
}
## keep 2 decimal
generateQuantileLabels2 <- function(quantile_breaks) {
  sapply(1:(length(quantile_breaks) - 1), function(i) {
    paste(format(round(quantile_breaks[i], 2), nsmall = 2),
          "-",
          format(round(quantile_breaks[i + 1], 2), nsmall = 2),
          sep = "")
  })
}
## keep 1
generateQuantileLabels1 <- function(quantile_breaks) {
  sapply(1:(length(quantile_breaks) - 1), function(i) {
    paste(format(round(quantile_breaks[i], 1), nsmall = 1),
          "-",
          format(round(quantile_breaks[i + 1], 1), nsmall = 1),
          sep = "")
  })
}


## keep int
generateQuantileLabels_int <- function(quantile_breaks) {
  sapply(1:(length(quantile_breaks) - 1), function(i) {
    paste(format(round(quantile_breaks[i], 0)),
          "-",
          format(round(quantile_breaks[i + 1], 0)),
          sep = "")
  })
}

```

```{r S6 data_process_plot functions}
process_in_file <- function(data, harmolandtype_area) {
    # Read the CSV file
    # in_Sagb_co2->data
    # Process the data
    data %>%
      dplyr::select(-3) %>%
    filter(harm_type == "Forest") %>%
    group_by(child.nodes) %>%
    pivot_wider(names_from = "year",values_from = "scalar")%>%
    ungroup()%>%
    dplyr::select(-2) %>%
    left_join(in_Harmolandtype_area, by = c("out_reg_code", "out_lu_code", "harm_type")) %>%
      dplyr::select(-7, -6) %>%
      group_by(region, harm_type) %>%
      mutate(region_pft_area = sum(pft_area_total, na.rm = TRUE)) %>%
      mutate(region_pft_area_weight = pft_area_total / region_pft_area) %>%
      summarize(across(
        .cols = 4:20,
        .fns = ~ weighted.mean(.x, w = region_pft_area_weight, na.rm = TRUE)
      )) %>%
      ungroup() %>%
      pivot_longer(cols = 3:ncol(.),
                   names_to = "year",
                   values_to = "scalar") %>%
      mutate(year = as.numeric(year)) %>%
      na.omit()%>%
    pivot_wider(names_from = harm_type, values_from = scalar) %>%
    ungroup() %>%
  # rename(
  #   SSP1 = GCAM_SSP1,
  #   SSP2 = GCAM_SSP2,
  #   SSP3 = GCAM_SSP3,
  #   SSP4 = GCAM_SSP4,
  #   SSP5 = GCAM_SSP5
  # ) %>%
  left_join(data_sf, by = c("region" = "reg_nm"))
}
###########################################
# Function to create individual plots
create_plot <- function(data,y_var, harm_type, x_label = "", y_label = "", title, ylim_range = c(-0.4, 0.8)) {
  ggplot(data %>% filter(harm_type == harm_type), aes(x = as.numeric(year), y = !!sym(y_var),group = region, color = region)) +
    geom_line() +
    labs(title = title,
         x = x_label,
         y = y_label,
         color = "Region") +
    theme_minimal() +
    theme(panel.border = element_rect(color = "black", fill = NA, size = 1),
          legend.position = "none",
          plot.title = element_text(hjust = 0.5)) +
    ylim(ylim_range)
}
###############################################
# Function to save the regional combined plots for each CC component
# Define plot size

save_combined_plot <- function(plot, name_suffix,wid_size=17*0.7,hei_size=10*0.7) {
  file_base <- paste0(fig_save_path, "/",Fig_num_name, "_combined_",forcing_short,"_", name_suffix, "_regions_v", version_num)
  
  ggsave(paste0(file_base, ".svg"), plot = plot, width = wid_size, height = hei_size, units = "in")
  ggsave(paste0(file_base, ".pdf"), plot = plot, width = wid_size, height = hei_size, units = "in")
  ggsave(paste0(file_base, ".png"), plot = plot, width = wid_size, height = hei_size, units = "in", dpi = 300)
  ggsave(filename = paste0(file_base, ".tif"), plot = plot, width = wid_size, height = hei_size, units = "in", device = "tiff", dpi = 300)
}

```

```{r functions prepare for plotting }

assign_colors <- function(x, breaks, colors) {
  cut(x,
      breaks = breaks,
      include.lowest = TRUE,
      labels = FALSE) %>%
    {
      colors[.]
    }
}


assign_quantile_categories <- function(x, breaks) {
  cut(x,
      breaks = breaks,
      include.lowest = TRUE,
      labels = FALSE) %>%
    factor(levels = 1:length(breaks))
}
```

```{r S7 plot and save regional agb scaler group map}



##########################
# Initialize empty lists to store plots and processed data
pagb_list <- list()
check_belowCD_long_gmean_list <- list()

##################





SSPs_combine<-processed_combine_diff_s_SSP126%>%
    rename(SSP126=gfdl_ukesm_mean_for_diff)%>%
    left_join(processed_combine_diff_s_SSP370%>%
    rename(SSP370=gfdl_ukesm_mean_for_diff), by = c("region","landleaf","year","key","reg_id","geometry"))%>%
    left_join(processed_combine_diff_s_SSP585%>%
    rename(SSP585=gfdl_ukesm_mean_for_diff), by = c("region","landleaf","year","key","reg_id","geometry"))

saveRDS(SSPs_combine, file = paste0(fig_save_path,"Fig61_SSPs_combine.rds"))
  
##"Cropland"          "Others"            "Bioenergy"         "Managed forest"    "Unmanaged forest"  "Grass"            
## "Managed pasture"   "Unmanaged pasture" "Shrubs"    




SSPs_combine_managedpasture<-SSPs_combine%>%
  filter(landleaf=="Managed pasture")
SSPs_combine_Unmanagedpasture<-SSPs_combine%>%
  filter(landleaf=="Unmanaged pasture")

SSPs_combine_managedforest<-SSPs_combine%>%
  filter(landleaf=="Managed forest")
SSPs_combine_Unmanagedforest<-SSPs_combine%>%
  filter(landleaf=="Unmanaged forest")

SSPs_combine_Cropland<-SSPs_combine%>%
  filter(landleaf=="Cropland")

SSPs_combine_Bioenergy<-SSPs_combine%>%
  filter(landleaf=="Bioenergy")

SSPs_combine_Grass<-SSPs_combine%>%
  filter(landleaf=="Grass")

SSPs_combine_Shrubs<-SSPs_combine%>%
  filter(landleaf=="Shrubs")



########################


quantile_breaks_um_f <-
  quantile(
    c(SSPs_combine_Unmanagedforest$SSP126, SSPs_combine_Unmanagedforest$SSP370, SSPs_combine_Unmanagedforest$SSP585
      # ,check_belowCD_long_combine$CO2, check_belowCD_long_combine$N_dep, check_belowCD_long_combine$tempperci
      ),
    probs = seq(0, 1, by = 1 / 7),
    na.rm = TRUE
  )

quantile_breaks_f <-
  quantile(
    c(SSPs_combine_managedforest$SSP126, SSPs_combine_managedforest$SSP370, SSPs_combine_managedforest$SSP585
      # ,check_belowCD_long_combine$CO2, check_belowCD_long_combine$N_dep, check_belowCD_long_combine$tempperci
      ),
    probs = seq(0, 1, by = 1 / 7),
    na.rm = TRUE
  )


quantile_breaks <-
  quantile(
    c(SSPs_combine$SSP126, SSPs_combine$SSP370, SSPs_combine$SSP585
      # ,check_belowCD_long_combine$CO2, check_belowCD_long_combine$N_dep, check_belowCD_long_combine$tempperci
      ),
    probs = seq(0, 1, by = 1 / 7),
    na.rm = TRUE
  )



quantile_breaks[1] <- -10000
quantile_breaks[2] <- -300
quantile_breaks[3] <- -200
quantile_breaks[4] <- -100
quantile_breaks[5] <- 0
quantile_breaks[6] <- 100
quantile_breaks[7] <- 200
# quantile_breaks[8] <- 300




  
quantile_labels <- generateQuantileLabels1(quantile_breaks)



quantile_labels[1] <- "<-300"

quantile_labels[7] <- ">200"





color_values <-
  c("#FF6503",
    "#FA8F00",
    "#FFC013",
    "#ffffb2",
    "#B1E919",
    "#64C822",
    "#2BA428"
    )

color_values_old <-
  c("#FD8D4F",
    "#feb24c",
    "#fed976",
    "#ffffb2",
    "#d9ef8b",
    "#a6d96a",
    "#66bd63"
    )
# reversed_color_values_b <- rev(color_values_FP_b)



#################################################################################
#################################################################################
#################################################################################
#################################################################################

##"Cropland"          "Others"            "Bioenergy"         "Managed forest"    "Unmanaged forest"  "Grass"            
## "Managed pasture"   "Unmanaged pasture" "Shrubs"    


####################################################
# Define a helper function to assign quantile categories
assign_quantile_to_scenarios <- function(dataset, scenarios, quantile_breaks) {
  for (scenario in scenarios) {
    column_name <- paste0("quantile_cat_", substr(scenario, 4, 6)) # Extracts 126, 370, 585 from scenario names
    dataset[[column_name]] <- assign_quantile_categories(dataset[[scenario]], quantile_breaks)
  }
  return(dataset)
}

# Define datasets and scenarios
datasets <- list(
  SSPs_combine_managedpasture,
  SSPs_combine_Unmanagedpasture,
  SSPs_combine_managedforest,
  SSPs_combine_Unmanagedforest,
  SSPs_combine_Cropland,
  SSPs_combine_Bioenergy,
  SSPs_combine_Grass,
  SSPs_combine_Shrubs
)

dataset_names <- c(
  "SSPs_combine_managedpasture",
  "SSPs_combine_Unmanagedpasture",
  "SSPs_combine_managedforest",
  "SSPs_combine_Unmanagedforest",
  "SSPs_combine_Cropland",
  "SSPs_combine_Bioenergy",
  "SSPs_combine_Grass",
  "SSPs_combine_Shrubs"
)

scenarios <- c("SSP126", "SSP370", "SSP585")

# Apply the function to each dataset
for (i in seq_along(datasets)) {
  assign(dataset_names[i], assign_quantile_to_scenarios(datasets[[i]], scenarios, quantile_breaks))
}

##################################################
SSPs_combine_legend<-SSPs_combine
SSPs_combine_legend$quantile_cat_3 <-
  assign_quantile_categories(SSPs_combine_legend$SSP585, quantile_breaks)




  
   
  plot_C_scalar <- function(data, fill_col, Title,num_label,h_value,show_legend = FALSE,y_title = "",if_ytitle=FALSE,ifxlabel=FALSE) {
    
    # data<-check_belowCD_long
    # fill_col<-"quantile_cat_1"
    # Title<-"Forest"
    # num_label<-"a"
    # h_value<-21
    # show_legend <- TRUE
    
    
  
  x_ticks <- seq(-180, 180, by = 90)  # Longitude range from -180 to 180 with 60-degree increments
  y_ticks <- seq(-60, 85, by = 45)    # Latitude range from -90 to 90 with 30-degree increments

  x_labels <- paste0(x_ticks, "°E")  # Append "°E" to each x tick label
  y_labels <- paste0(y_ticks, "°N")  # Append "°N" to each y tick label
  
  
 # p1<- 
   p<-ggplot(data) +
    geom_sf(aes(geometry = geometry, fill = !!sym(fill_col)), color = "grey25") +
    scale_fill_manual(
      values = color_values,
      name = expression("LULCC difference"),
      # new add
      limits = c("1","2","3","4","5","6","7"),# make sure every legend level will be shown
      labels = quantile_labels
    ) +
    theme_base() +
    labs(
      y = y_title,
      x = '',
      title = paste0(Title)
    ) +
     scale_x_continuous(breaks = x_ticks, labels = x_labels) +
    scale_y_continuous(breaks = y_ticks, labels = y_labels) +
    theme(
      panel.grid = element_blank(),
      panel.background = element_rect(fill = "white", colour = NA),
      plot.background = element_rect(fill = "white", colour = NA),
      plot.title = element_text(hjust = 0.5, size = 15),
      axis.title.x = element_text(size = 15),
      axis.title.y = element_text(size = 15, face = "bold"),
      axis.text.x = element_text(size = 14.5),
      axis.text.y = element_text(size = 14.5),
      legend.text = element_text(size = 15),
      legend.title = element_text(size = 15),
      legend.position = ifelse(show_legend, "right", "none"),
      plot.margin = margin(t = 0, r = 0, b = 0, l = 0)
    ) +
    annotate(
      "text",
      x = Inf,
      y = Inf,
      label = paste0("(", num_label, ")"),
      hjust = h_value,
      vjust = 1.5,
      size = 4.5
    ) +
    guides(fill = guide_legend(keyheight = unit(1, "cm"), keywidth = unit(1, "cm"),        
                               reverse = TRUE  # Reverse the legend order
                               ))
   
   
   if (!if_ytitle) {
    p <- p +
      theme(axis.text.y = element_blank(),
            axis.ticks.y = element_blank())
  }

  if (ifxlabel) {p<-p
    
  }else if (ifxlabel == FALSE) {
  p <- p +
      theme(axis.text.x = element_blank(),
            axis.ticks.x = element_blank())}
   return(p)
  }
  
 ##########################################



# Helper function to generate plots
generate_plot <- function(data, quantile_cat, ssp, label, y_title, if_ytitle, ifxlabel) {
  plot_C_scalar(data, quantile_cat, ssp, label, 1000, y_title = y_title, if_ytitle = if_ytitle, ifxlabel = ifxlabel) +
    theme(
      legend.margin = margin(t = 0, r = 15, b = 0, l = 0)  # Adjust the values to increase/decrease margin
    )
}

# Managed pasture plots
p_managedpasture <- list(
  SSP1 = generate_plot(SSPs_combine_managedpasture, "quantile_cat_126", "SSP126", "a", "", TRUE, FALSE),
  SSP3 = generate_plot(SSPs_combine_managedpasture, "quantile_cat_370", "SSP370", "b", "", FALSE, FALSE),
  SSP5 = generate_plot(SSPs_combine_managedpasture, "quantile_cat_585", "SSP585", "c", "", FALSE, FALSE)
)

# UnManaged pasture plots
p_Unmanagedpasture <- list(
  SSP1 = generate_plot(SSPs_combine_Unmanagedpasture, "quantile_cat_126", "", "", "", TRUE, FALSE),
  SSP3 = generate_plot(SSPs_combine_Unmanagedpasture, "quantile_cat_370", "", "", "", FALSE, FALSE),
  SSP5 = generate_plot(SSPs_combine_Unmanagedpasture, "quantile_cat_585", "", "", "", FALSE, FALSE)
)

# Managed forest plots
p_managedforest <- list(
  SSP1 = generate_plot(SSPs_combine_managedforest, "quantile_cat_126", "", "", "", TRUE, FALSE),
  SSP3 = generate_plot(SSPs_combine_managedforest, "quantile_cat_370", "", "", "", FALSE, FALSE),
  SSP5 = generate_plot(SSPs_combine_managedforest, "quantile_cat_585", "", "", "", FALSE, FALSE)
)

# UnManaged forest plots
p_Unmanagedforest <- list(
  SSP1 = generate_plot(SSPs_combine_Unmanagedforest, "quantile_cat_126", "", "", "", TRUE, FALSE),
  SSP3 = generate_plot(SSPs_combine_Unmanagedforest, "quantile_cat_370", "", "", "", FALSE, FALSE),
  SSP5 = generate_plot(SSPs_combine_Unmanagedforest, "quantile_cat_585", "", "", "", FALSE, FALSE)
)

p_Cropland <- list(
  SSP1 = generate_plot(SSPs_combine_Cropland, "quantile_cat_126", "", "", "", TRUE, FALSE),
  SSP3 = generate_plot(SSPs_combine_Cropland, "quantile_cat_370", "", "", "", FALSE, FALSE),
  SSP5 = generate_plot(SSPs_combine_Cropland, "quantile_cat_585", "", "", "", FALSE, FALSE)
)

p_Bioenergy <- list(
  SSP1 = generate_plot(SSPs_combine_Bioenergy, "quantile_cat_126", "", "", "", TRUE, FALSE),
  SSP3 = generate_plot(SSPs_combine_Bioenergy, "quantile_cat_370", "", "", "", FALSE, FALSE),
  SSP5 = generate_plot(SSPs_combine_Bioenergy, "quantile_cat_585", "", "", "", FALSE, FALSE)
)

p_Grass <- list(
  SSP1 = generate_plot(SSPs_combine_Grass, "quantile_cat_126", "", "", "", TRUE, FALSE),
  SSP3 = generate_plot(SSPs_combine_Grass, "quantile_cat_370", "", "", "", FALSE, FALSE),
  SSP5 = generate_plot(SSPs_combine_Grass, "quantile_cat_585", "", "", "", FALSE, FALSE)
)

p_Shrubs <- list(
  SSP1 = generate_plot(SSPs_combine_Shrubs, "quantile_cat_126", "", "", "", TRUE, TRUE),
  SSP3 = generate_plot(SSPs_combine_Shrubs, "quantile_cat_370", "", "", "", FALSE, TRUE),
  SSP5 = generate_plot(SSPs_combine_Shrubs, "quantile_cat_585", "", "", "", FALSE, TRUE)
)






P_C_legend <- plot_C_scalar(SSPs_combine_legend,"quantile_cat_3", "","e",19.9,y_title= "",if_ytitle=FALSE,ifxlabel=FALSE,show_legend = TRUE)+
  theme(
    legend.margin = margin(10, 10, 10, 10),  # Adjust the values to increase/decrease margin
    legend.title = element_blank()
  # Adjust margin
    # legend.text = element_text(size = 6),  # Adjust legend text size
    # legend.title = element_text(size = 6),  # Adjust legend title size
    # legend.key.size = unit(0.1, "lines")  # Adjust legend key size
  )

##############################################################################################################
##############################################################################################################  
##############################################################################################################
 

legend <- cowplot::get_legend(P_C_legend)




 
```



```{r save plot}
p_managedpasture_plots<-wrap_plots(p_managedpasture$SSP1,
                                   p_managedpasture$SSP3,
                                   p_managedpasture$SSP5,
                                   nrow = 1)

p_Unmanagedpasture_plots<-wrap_plots(p_Unmanagedpasture$SSP1,
                                   p_Unmanagedpasture$SSP3,
                                   p_Unmanagedpasture$SSP5,
                                   nrow = 1)

p_managedpasture_plots<-wrap_plots(p_managedpasture$SSP1,
                                   p_managedpasture$SSP3,
                                   p_managedpasture$SSP5,
                                   nrow = 1)

p_managedforest_plots<-wrap_plots(p_managedforest$SSP1,
                                   p_managedforest$SSP3,
                                   p_managedforest$SSP5,
                                   nrow = 1)

p_Unmanagedforest_plots<-wrap_plots(p_Unmanagedforest$SSP1,
                                   p_Unmanagedforest$SSP3,
                                   p_Unmanagedforest$SSP5,
                                   nrow = 1)

p_Cropland_plots<-wrap_plots(p_Cropland$SSP1,
                                   p_Cropland$SSP3,
                                   p_Cropland$SSP5,
                                   nrow = 1)

p_Bioenergy_plots<-wrap_plots(p_Bioenergy$SSP1,
                                   p_Bioenergy$SSP3,
                                   p_Bioenergy$SSP5,
                                   nrow = 1)

p_Grass_plots<-wrap_plots(p_Grass$SSP1,
                                   p_Grass$SSP3,
                                   p_Grass$SSP5,
                                   nrow = 1)



p_Shrubs_plots<-wrap_plots(p_Shrubs$SSP1,
                                   p_Shrubs$SSP3,
                                   p_Shrubs$SSP5,
                                   nrow = 1)

  # p_managedpasture$SSP1,
  # p_Unmanagedpasture$SSP1,
  # p_managedforest$SSP1,
  # p_Unmanagedforest$SSP1,
  # p_Cropland$SSP1,
  # p_Bioenergy$SSP1,
  # p_Grass$SSP1,
  # p_Shrubs$SSP1



ggsave(paste0(fig_save_path, "/Fig61_3SSP_regional_spatial_2forcings_mean_man_pasture_v",version_num,".pdf"), plot = p_managedpasture_plots, width = 15*0.81, height = 5*0.81, units = "in")


ggsave(paste0(fig_save_path, "/Fig61_3SSP_regional_spatial_2forcings_mean_Unman_pasture_v",version_num,".pdf"), plot = p_Unmanagedpasture_plots, width = 15*0.81, height = 5*0.81, units = "in")


ggsave(paste0(fig_save_path, "/Fig61_3SSP_regional_spatial_2forcings_mean_man_forest_v",version_num,".pdf"), plot = p_managedforest_plots, width = 15*0.81, height = 5*0.81, units = "in")

ggsave(paste0(fig_save_path, "/Fig61_3SSP_regional_spatial_2forcings_mean_Unman_forest_v",version_num,".pdf"), plot = p_Unmanagedforest_plots, width = 15*0.81, height = 5*0.81, units = "in")

ggsave(paste0(fig_save_path, "/Fig61_3SSP_regional_spatial_2forcings_mean_Cropland_v",version_num,".pdf"), plot = p_Cropland_plots, width = 15*0.81, height = 5*0.81, units = "in")

ggsave(paste0(fig_save_path, "/Fig61_3SSP_regional_spatial_2forcings_mean_Bioenergy_v",version_num,".pdf"), plot = p_Bioenergy_plots, width = 15*0.81, height = 5*0.81, units = "in")


ggsave(paste0(fig_save_path, "/Fig61_3SSP_regional_spatial_2forcings_mean_Grass_v",version_num,".pdf"), plot = p_Grass_plots, width = 15*0.81, height = 5*0.81, units = "in")



ggsave(paste0(fig_save_path, "/Fig61_3SSP_regional_spatial_2forcings_mean_man_Shrubs_v",version_num,".pdf"), plot = p_Shrubs_plots, width = 15*0.81, height = 5*0.81, units = "in")

## legend
ggsave(paste0(fig_save_path, "/Fig61_3SSP_regional_spatial_2forcings_mean_man_legend_v",version_num,".pdf"), plot = legend, width = 15*0.81, height = 5*0.81, units = "in")





# ggsave(paste0(fig_save_path, "/Fig61_3SSP_regional_spatial_2forcings_mean_8types_v",version_num,".svg"), plot = p_managedpasture_plots , width = 15*0.81, height = 5*0.81, units = "in")
# 
# 
# 
# ggsave(paste0(fig_save_path, "/Fig61_3SSP_regional_spatial_2forcings_mean_8types_v",version_num,".png"), plot = combined_global_bgb_plot, width = 15*0.81, height = 9*0.81, units = "in", dpi = 300)
# 
# ggsave(filename = paste0(fig_save_path,"/Fig61_3SSP_regional_spatial_2forcings_mean_8types_v", version_num, ".tif"),
#      plot = combined_global_bgb_plot,
#      width = 15*0.81,
#      height = 9*0.81,
#      units = "in",
#      device = "tiff",
#      dpi = 300)




```






